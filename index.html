<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAB-seq v2 Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            background: #e8e8e8;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .terminal-wrapper {
            width: 100%;
            max-width: 900px;
            filter: drop-shadow(0 10px 40px rgba(0, 0, 0, 0.15));
        }

        .terminal-container {
            background: #ffffff;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid #d0d0d0;
        }

        .terminal-header {
            padding: 12px 16px;
            background: linear-gradient(180deg, #f6f6f6 0%, #e8e8e8 100%);
            border-bottom: 1px solid #d0d0d0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .window-controls { display: flex; gap: 8px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot.red { background: #ff5f57; }
        .dot.yellow { background: #febc2e; }
        .dot.green { background: #28c840; }

        .terminal-title {
            flex: 1;
            text-align: center;
            color: #555;
            font-size: 13px;
            font-weight: 500;
        }

        .terminal-badge {
            background: #0969da;
            color: #fff;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }

        .terminal-body {
            height: 480px;
            overflow-y: auto;
            padding: 16px;
            font-size: 13px;
            line-height: 1.6;
            cursor: text;
            background: #fafafa;
        }

        .terminal-line { white-space: pre-wrap; word-wrap: break-word; }
        .terminal-input-line { display: flex; align-items: center; margin-top: 4px; }
        .terminal-prompt { color: #1a7f37; font-weight: 600; margin-right: 8px; }
        .terminal-prompt .path { color: #0969da; }

        #terminal-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: #1f2328;
            font-family: inherit;
            font-size: 13px;
            caret-color: #0969da;
        }
        #terminal-input:disabled { opacity: 0.5; }

        /* High contrast colors for light background */
        .c-default { color: #1f2328; }
        .c-gray { color: #656d76; }
        .c-green { color: #1a7f37; }
        .c-cyan { color: #0969da; }
        .c-yellow { color: #9a6700; }
        .c-red { color: #cf222e; }
        .c-purple { color: #8250df; }

        .terminal-body::-webkit-scrollbar { width: 8px; }
        .terminal-body::-webkit-scrollbar-track { background: #f0f0f0; }
        .terminal-body::-webkit-scrollbar-thumb { background: #c0c0c0; border-radius: 4px; }

        .terminal-footer {
            padding: 8px 16px;
            background: #f6f6f6;
            border-top: 1px solid #d0d0d0;
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #656d76;
        }
        .terminal-footer a { color: #0969da; text-decoration: none; }
        .terminal-footer a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="terminal-wrapper">
        <div class="terminal-container">
            <div class="terminal-header">
                <div class="window-controls">
                    <span class="dot red"></span>
                    <span class="dot yellow"></span>
                    <span class="dot green"></span>
                </div>
                <div class="terminal-title">dabseq — bash</div>
                <div class="terminal-badge">C++17</div>
            </div>
            <div class="terminal-body" id="terminal-body">
                <div id="terminal-output"></div>
                <div class="terminal-input-line">
                    <span class="terminal-prompt" id="prompt">user:<span class="path">~</span>$</span>
                    <input type="text" id="terminal-input" autofocus autocomplete="off" spellcheck="false">
                </div>
            </div>
            <div class="terminal-footer">
                <span>DAB-seq v2 — Single-Cell Leukemia Sequencing Pipeline</span>
                <a href="https://github.com/gjberger/dabseq_v2" target="_blank">github.com/gjberger/dabseq_v2</a>
            </div>
        </div>
    </div>

    <script>
        const terminalOutput = document.getElementById('terminal-output');
        const terminalInput = document.getElementById('terminal-input');
        const terminalBody = document.getElementById('terminal-body');
        const promptEl = document.getElementById('prompt');
        
        let commandHistory = [];
        let historyIndex = -1;
        let isProcessing = false;
        let currentPath = '~';

        const filesystem = {
            '~': { contents: ['data/', 'cell_counts/', 'src/', 'dabseq', 'Makefile', 'README.md'] },
            '~/data': { contents: ['R1.fastq.gz', 'R2.fastq.gz', 'cell_barcodes.csv', 'antibody_barcodes.csv'] },
            '~/cell_counts': { contents: [] },
            '~/src': { contents: ['main.cpp', 'fastq_reader.cpp', 'fastq_reader.h', 'barcode_index.cpp', 'barcode_index.h', 'dabseq_utilities.cpp', 'dabseq_utilities.h'] }
        };

        const fileContents = {
            'README.md': `# DAB-seq v2
C++ data processing pipeline for high-throughput
single-cell leukemia sequencing data.

Usage:
  ./dabseq R1.fastq[.gz] R2.fastq[.gz] cell_barcodes.csv antibody_barcodes.csv

Build:
  make`,
            'Makefile': `CXX = g++
CXXFLAGS = -std=c++17 -O3 -Wall
LDFLAGS = -lz -lhts

SRCS = main.cpp fastq_reader.cpp barcode_index.cpp dabseq_utilities.cpp
TARGET = dabseq

all: $(TARGET)

$(TARGET): $(SRCS)
	$(CXX) $(CXXFLAGS) -o $@ $^ $(LDFLAGS)

clean:
	rm -f $(TARGET)`,
            'cell_barcodes.csv': `TAGACCATG,1
TGAACGGTT,2
AAACCTGAG,3
GAAACGAGT,4
... (1536 Mission Bio cell barcodes)`,
            'antibody_barcodes.csv': `CCGTGTTCCTCATTA,CD71
TCACCAGTACCTCAT,CD34
GACAAGTGATCTGCA,CD38
TGTGTATTCCCTTGT,CD45
ATGTTTTGGCTCAAT,CD117
... (46 TotalSeq-B antibodies)`
        };

        function addLine(text, className = 'c-default') {
            const line = document.createElement('div');
            line.className = `terminal-line ${className}`;
            line.innerHTML = text || '&nbsp;';
            terminalOutput.appendChild(line);
            terminalBody.scrollTop = terminalBody.scrollHeight;
        }

        function addHTML(html) {
            const line = document.createElement('div');
            line.className = 'terminal-line';
            line.innerHTML = html;
            terminalOutput.appendChild(line);
            terminalBody.scrollTop = terminalBody.scrollHeight;
        }

        function updatePrompt() {
            promptEl.innerHTML = `user:<span class="path">${currentPath}</span>$`;
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        function resolvePath(p) {
            if (!p || p === '~') return '~';
            if (p === '..') return currentPath === '~' ? '~' : (currentPath.split('/').slice(0, -1).join('/') || '~');
            if (p.startsWith('~/')) return p;
            const clean = p.replace(/\/$/, '');
            return currentPath === '~' ? `~/${clean}` : `${currentPath}/${clean}`;
        }

        const commands = {
            help: async () => {
                addLine('');
                addHTML('<span class="c-cyan">Commands:</span>');
                addHTML('  ls, cd, cat, pwd, clear, make, help');
                addLine('');
                addHTML('<span class="c-cyan">Pipeline:</span>');
                addHTML('  ./dabseq R1.fastq R2.fastq cell_barcodes.csv antibody_barcodes.csv');
                addLine('');
            },
            pwd: async () => { addLine(currentPath.replace('~', '/home/user')); },
            ls: async (args) => {
                const target = args?.[0] ? resolvePath(args[0]) : currentPath;
                const dir = filesystem[target];
                if (!dir) { addHTML(`<span class="c-red">ls: cannot access '${args[0]}': No such file or directory</span>`); return; }
                if (dir.contents.length === 0) return;
                const out = dir.contents.map(f => f.endsWith('/') ? `<span class="c-cyan">${f}</span>` : (f === 'dabseq' ? `<span class="c-green">${f}</span>` : f)).join('  ');
                addHTML(out);
            },
            cd: async (args) => {
                if (!args?.[0] || args[0] === '~') { currentPath = '~'; updatePrompt(); return; }
                const target = resolvePath(args[0]);
                if (filesystem[target]) { currentPath = target; updatePrompt(); }
                else { addHTML(`<span class="c-red">cd: ${args[0]}: No such file or directory</span>`); }
            },
            cat: async (args) => {
                if (!args?.[0]) { addHTML('<span class="c-red">cat: missing operand</span>'); return; }
                const name = args[0].replace('./', '');
                if (fileContents[name]) { fileContents[name].split('\n').forEach(l => addLine(l)); }
                else { addHTML(`<span class="c-red">cat: ${args[0]}: No such file or directory</span>`); }
            },
            clear: async () => { terminalOutput.innerHTML = ''; },
            make: async () => {
                addHTML('<span class="c-gray">g++ -std=c++17 -O3 -Wall -o dabseq main.cpp fastq_reader.cpp barcode_index.cpp dabseq_utilities.cpp -lz -lhts</span>');
                await sleep(600);
                addHTML('<span class="c-green">Build complete.</span>');
            }
        };

        async function runDabseq(args) {
            if (args.length !== 4) {
                addHTML('<span class="c-red">Usage: ./dabseq R1.fastq[.gz] R2.fastq[.gz] cell_barcodes.csv antibody_barcodes.csv</span>');
                return;
            }

            const totalPairs = 10000;
            const numWithBarcodes = 8734;
            const numWithAbPayload = 7621;
            const numWithBoth = 7156;

            await sleep(400);
            addLine('');
            addLine(' Summary over ' + totalPairs + ' pairs:');
            addLine(numWithBarcodes + ' have valid cell barcodes');
            addLine(numWithAbPayload + ' have valid ab payloads');
            addLine(numWithBoth + ' have both cell + ab');
            
            await sleep(300);
            addLine('');
            addLine(' cell_id     antibody_barcode     count');
            
            await sleep(400);
            
            filesystem['~/cell_counts'].contents = [
                'cell_TAGACCATG_TGAACGGTT.csv',
                'cell_AAACCTGAG_GAAACGAGT.csv',
                'cell_TCGATCGAT_ATCGATCGA.csv'
            ];
            
            addLine('');
        }

        async function executeCommand(input) {
            const parts = input.trim().split(/\s+/);
            const cmd = parts[0];
            const args = parts.slice(1);

            addHTML(`<span class="c-green">user</span>:<span class="c-cyan">${currentPath}</span>$ ${input}`);

            if (!cmd) return;

            if (cmd === './dabseq' || cmd === 'dabseq') {
                await runDabseq(args);
            } else if (commands[cmd.toLowerCase()]) {
                await commands[cmd.toLowerCase()](args);
            } else {
                addHTML(`<span class="c-red">${cmd}: command not found</span>`);
            }
        }

        function showWelcome() {
            addHTML('<span class="c-cyan">DAB-seq v2</span> <span class="c-gray">— C++ single-cell sequencing pipeline</span>');
            addHTML('<span class="c-gray">Type "help" for commands</span>');
            addLine('');
        }

        terminalInput.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter' && !isProcessing) {
                const cmd = terminalInput.value;
                terminalInput.value = '';
                if (cmd.trim()) { commandHistory.push(cmd); historyIndex = -1; }
                isProcessing = true;
                terminalInput.disabled = true;
                await executeCommand(cmd);
                isProcessing = false;
                terminalInput.disabled = false;
                terminalInput.focus();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (commandHistory.length > 0) {
                    historyIndex = historyIndex === -1 ? commandHistory.length - 1 : Math.max(0, historyIndex - 1);
                    terminalInput.value = commandHistory[historyIndex];
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (historyIndex !== -1) {
                    historyIndex++;
                    terminalInput.value = historyIndex >= commandHistory.length ? (historyIndex = -1, '') : commandHistory[historyIndex];
                }
            }
        });

        terminalBody.addEventListener('click', () => terminalInput.focus());
        showWelcome();
    </script>
</body>
</html>
