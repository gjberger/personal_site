<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAB-seq Terminal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/xterm/5.3.0/xterm.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0d1117;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .terminal-window {
            width: 100%;
            max-width: 900px;
            background: #161b22;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .titlebar {
            background: #21262d;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .dot.red { background: #ff5f57; }
        .dot.yellow { background: #febc2e; }
        .dot.green { background: #28c840; }

        .title {
            flex: 1;
            text-align: center;
            font-family: monospace;
            font-size: 13px;
            color: #8b949e;
        }

        #terminal {
            height: 500px;
        }

        .xterm-viewport {
            background: #161b22 !important;
        }
    </style>
</head>
<body>
    <div class="terminal-window">
        <div class="titlebar">
            <span class="dot red"></span>
            <span class="dot yellow"></span>
            <span class="dot green"></span>
            <span class="title">dabseq — bash</span>
        </div>
        <div id="terminal"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/5.3.0/xterm.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm-addon-fit/0.8.0/xterm-addon-fit.min.js"></script>
    <script>
        const term = new Terminal({
            theme: {
                background: '#161b22',
                foreground: '#c9d1d9',
                cursor: '#58a6ff',
                black: '#0d1117',
                red: '#ff7b72',
                green: '#3fb950',
                yellow: '#d29922',
                blue: '#58a6ff',
                magenta: '#f778ba',
                cyan: '#a5d6ff',
                white: '#c9d1d9',
                brightBlack: '#6e7681',
                brightGreen: '#56d364',
            },
            fontFamily: 'Consolas, Monaco, "Courier New", monospace',
            fontSize: 14,
            lineHeight: 1.3,
            cursorBlink: true
        });

        const fitAddon = new FitAddon.FitAddon();
        term.loadAddon(fitAddon);
        term.open(document.getElementById('terminal'));
        fitAddon.fit();
        window.addEventListener('resize', () => fitAddon.fit());

        // State
        let line = '';
        let busy = false;
        let cwd = '~';

        // Simulated filesystem
        const fs = {
            '~': ['barcodes/', 'fastq/', 'config/', 'output/', 'dabseq_pipeline.py', 'README.md'],
            '~/barcodes': ['cell_barcodes_v1.txt', 'antibody_barcodes.csv'],
            '~/fastq': ['panel_R1.fastq.gz', 'panel_R2.fastq.gz', 'abs_R1.fastq.gz', 'abs_R2.fastq.gz'],
            '~/config': ['dabseq.hg19.cfg', 'panel_targets.bed'],
            '~/output': []
        };

        // Colors
        const c = {
            r: '\x1b[0m',
            green: '\x1b[32m',
            blue: '\x1b[34m',
            cyan: '\x1b[36m',
            yellow: '\x1b[33m',
            red: '\x1b[31m',
            magenta: '\x1b[35m',
            gray: '\x1b[90m',
            bold: '\x1b[1m'
        };

        function prompt() {
            term.write(`${c.green}user${c.r}:${c.blue}${cwd}${c.r}$ `);
        }

        function sleep(ms) {
            return new Promise(r => setTimeout(r, ms));
        }

        async function progress(label, steps = 20, time = 1500) {
            for (let i = 0; i <= steps; i++) {
                const pct = Math.round((i / steps) * 100);
                const bar = '='.repeat(i) + '>' + ' '.repeat(steps - i);
                term.write(`\r  ${label} [${bar}] ${pct}%`);
                await sleep(time / steps);
            }
            term.writeln('');
        }

        // Commands
        const cmds = {
            help() {
                term.writeln('');
                term.writeln('Available commands:');
                term.writeln('  ls                    List directory contents');
                term.writeln('  cd <dir>              Change directory');
                term.writeln('  cat <file>            View file contents');
                term.writeln('  pwd                   Print working directory');
                term.writeln('  clear                 Clear terminal');
                term.writeln('');
                term.writeln('  dabseq_pipeline.py barcode [options]');
                term.writeln('  dabseq_pipeline.py genotype [options]');
                term.writeln('');
                term.writeln('Options:');
                term.writeln('  -c, --cell-barcodes   Cell barcode file');
                term.writeln('  -a, --ab-barcodes     Antibody barcode file');
                term.writeln('  --panel-r1/r2         DNA panel FASTQ files');
                term.writeln('  --abs-r1/r2           Antibody FASTQ files');
                term.writeln('  --dna-only            DNA genotyping only');
                term.writeln('  --ab-only             Antibody counting only');
                term.writeln('');
            },

            pwd() {
                term.writeln(cwd.replace('~', '/home/user'));
            },

            ls(args) {
                let dir = cwd;
                if (args[0]) {
                    dir = resolvePath(args[0]);
                }
                const contents = fs[dir];
                if (!contents) {
                    term.writeln(`ls: cannot access '${args[0]}': No such file or directory`);
                    return;
                }
                const out = contents.map(f => f.endsWith('/') ? `${c.blue}${f}${c.r}` : f);
                term.writeln(out.join('  '));
            },

            cd(args) {
                if (!args[0] || args[0] === '~') {
                    cwd = '~';
                    return;
                }
                if (args[0] === '..') {
                    if (cwd !== '~') {
                        cwd = cwd.split('/').slice(0, -1).join('/') || '~';
                    }
                    return;
                }
                const target = resolvePath(args[0]);
                if (fs[target]) {
                    cwd = target;
                } else {
                    term.writeln(`cd: ${args[0]}: No such file or directory`);
                }
            },

            cat(args) {
                if (!args[0]) {
                    term.writeln('cat: missing operand');
                    return;
                }
                const files = {
                    'README.md': `# DAB-seq Pipeline\nCombined single-cell DNA genotyping and protein quantification.\nAbate Lab @ UCSF`,
                    'cell_barcodes_v1.txt': `AAACCTGAGAAACCAT\nAAACCTGAGAAACGAG\nAAACCTGAGAAACTGT\nAAACCTGAGAAATGGT\n... (737,280 barcodes)`,
                    'antibody_barcodes.csv': `antibody,barcode,sequence\nCD34,AB001,AGTCAGTCAG\nCD38,AB002,TCGATCGATC\nCD45,AB003,GCTAGCTAGT\nCD117,AB004,ATCGATCGAT`,
                    'dabseq.hg19.cfg': `[reference]\ngenome = hg19\nfasta = /ref/hg19.fa\n\n[pipeline]\nthreads = 16\nmemory = 64G`,
                    'panel_targets.bed': `chr1\t115256528\t115256623\tNRAS\nchr7\t55241607\t55241727\tEGFR\nchr12\t25398208\t25398329\tKRAS`
                };
                const name = args[0].replace('./', '');
                if (files[name]) {
                    term.writeln(files[name]);
                } else {
                    term.writeln(`cat: ${args[0]}: No such file or directory`);
                }
            },

            clear() {
                term.clear();
            }
        };

        function resolvePath(p) {
            if (p.startsWith('~/')) return p;
            if (p.startsWith('/')) return '~' + p.replace('/home/user', '');
            let path = cwd + '/' + p.replace(/\/$/, '');
            return path.replace('~/', '~/').replace('//', '/');
        }

        async function runPipeline(mode, args) {
            const dnaOnly = args.includes('--dna-only');
            const abOnly = args.includes('--ab-only');

            term.writeln('');
            term.writeln(`${c.cyan}DAB-seq Pipeline v1.2${c.r}`);
            term.writeln(`Mode: ${mode}`);
            term.writeln('');

            if (mode === 'barcode') {
                term.writeln(`${c.yellow}[1/4]${c.r} Loading barcodes...`);
                await sleep(500);
                term.writeln(`  ${c.gray}→${c.r} 737,280 cell barcodes loaded`);
                if (!dnaOnly) term.writeln(`  ${c.gray}→${c.r} 8 antibody targets loaded`);
                term.writeln('');

                if (!abOnly) {
                    term.writeln(`${c.yellow}[2/4]${c.r} Processing DNA panel...`);
                    await progress('Demultiplex', 25, 2000);
                    await progress('Align', 25, 2500);
                    await progress('GVCF', 25, 2000);
                    term.writeln(`  ${c.green}✓${c.r} 12,847 cells processed`);
                    term.writeln('');
                }

                if (!dnaOnly) {
                    term.writeln(`${c.yellow}[3/4]${c.r} Processing antibody tags...`);
                    await progress('UMI count', 25, 1500);
                    await progress('Dedup', 25, 1000);
                    term.writeln(`  ${c.green}✓${c.r} 11,924 cells with antibody data`);
                    term.writeln('');
                }

                term.writeln(`${c.yellow}[4/4]${c.r} Writing outputs...`);
                await sleep(800);
                fs['~/output'].push('Sample1.gvcf.gz', 'Sample1.ab_counts.csv');
                term.writeln(`  ${c.gray}→${c.r} output/Sample1.gvcf.gz`);
                term.writeln(`  ${c.gray}→${c.r} output/Sample1.ab_counts.csv`);
                term.writeln('');
                term.writeln(`${c.green}Done!${c.r} Run genotype mode for joint calling.`);

            } else if (mode === 'genotype') {
                term.writeln(`${c.yellow}[1/3]${c.r} Importing GVCFs...`);
                await progress('GenomicsDB', 25, 2000);
                term.writeln('');

                term.writeln(`${c.yellow}[2/3]${c.r} Joint genotyping...`);
                await progress('GATK', 25, 3000);
                term.writeln(`  ${c.green}✓${c.r} 1,089 variants called`);
                term.writeln('');

                term.writeln(`${c.yellow}[3/3]${c.r} Generating matrices...`);
                await sleep(1000);
                fs['~/output'].push('genotypes.h5', 'antibody_counts.h5');
                term.writeln(`  ${c.gray}→${c.r} output/genotypes.h5`);
                term.writeln(`  ${c.gray}→${c.r} output/antibody_counts.h5`);
                term.writeln('');
                term.writeln(`${c.green}Done!${c.r} Results in output/`);
            }
            term.writeln('');
        }

        async function exec(input) {
            const parts = input.trim().split(/\s+/);
            const cmd = parts[0];
            const args = parts.slice(1);

            if (!cmd) return;

            if (cmd === 'dabseq_pipeline.py' || cmd === './dabseq_pipeline.py') {
                if (args[0] === 'barcode' || args[0] === 'genotype') {
                    await runPipeline(args[0], args.slice(1));
                } else if (args.includes('--help') || args.includes('-h')) {
                    cmds.help();
                } else {
                    term.writeln('Usage: dabseq_pipeline.py <barcode|genotype> [options]');
                    term.writeln('Try --help for more info.');
                }
            } else if (cmds[cmd]) {
                cmds[cmd](args);
            } else {
                term.writeln(`${cmd}: command not found`);
            }
        }

        term.onKey(async ({ domEvent }) => {
            if (busy) return;
            const key = domEvent.keyCode;

            if (key === 13) { // Enter
                term.writeln('');
                busy = true;
                await exec(line);
                line = '';
                busy = false;
                prompt();
            } else if (key === 8) { // Backspace
                if (line.length > 0) {
                    line = line.slice(0, -1);
                    term.write('\b \b');
                }
            } else if (domEvent.key.length === 1 && !domEvent.ctrlKey) {
                line += domEvent.key;
                term.write(domEvent.key);
            }
        });

        // Init
        term.writeln('DAB-seq Pipeline Simulator');
        term.writeln(`${c.gray}Type 'help' for commands${c.r}`);
        term.writeln('');
        prompt();
    </script>
</body>
</html>
